## 单例与序列化
序列化机制里有一个特殊的方法，它可以实现保护性复制整个对象。该方法会紧接着readObject()之后被调用，该方法的返回值会代替原来反序列化的对象，而原来readObject()反序列化的对象将会被立即抛弃。在序列化单例、枚举时有用。先看一下序列化对单例的破坏。
```Java
Object readResolve() throws ObjectStreamException;
```
## 序列化对单例的破坏
双重校验锁的单例类
```Java
import java.io.Serializable;

public class Singleton implements Serializable {
    private volatile static Singleton instance;

    private Singleton() {
    }

    public static Singleton getSingleton() {
        if (instance == null) {
            synchronized (Singleton.class) {
                if (instance == null) {
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
}
```
测试类
```Java
import myserializable.Singleton;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;

public class SingletonDemo {
    public static void main(String[] args) {
        ObjectOutputStream oos = null;
        try {
            oos = new ObjectOutputStream(new FileOutputStream("singleton.txt"));
            oos.writeObject(Singleton.getSingleton());
            oos.close();
        } catch (IOException e) {
            e.printStackTrace();
        }

        ObjectInputStream ois = null;
        try {
            ois = new ObjectInputStream(new FileInputStream("singleton.txt"));
            Singleton readInstance = (Singleton) ois.readObject();
            System.out.println(readInstance == Singleton.getSingleton()); // output: false
            ois.close();
        } catch (IOException e) {
            e.printStackTrace();
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```
输出结果为false，表明对Singleton序列化和反序列化后得到的是一个新的对象，这就破坏了Singleton的单例性。
## ObjectInputStream
反序列化通过ObjectInputStream来实现。分析一下ObjectInputStream的readObject()方法的执行情况。  
通过阅读源码，可以看到readObject()的调用栈：  
readObject()------> readObject0(boolean unshared)------>readOrdinaryObject(boolean unshared)------>readResolve()

## 参考资料
《疯狂java讲义第四版》  
[单例与序列化的那些事儿](http://www.hollischuang.com/archives/1144)
